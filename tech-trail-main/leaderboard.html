<csartifact identifier="leaderboard-fixed" type="application/vnd.cs.code" language="html" title="Fixed Leaderboard HTML">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Leaderboard - Tech In My Style</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Chart.js and Data Labels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="tech-no bg.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
    <link rel="icon" type="image/png" href="./img/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="./img/favicon.svg" />
    <link rel="shortcut icon" href="./img/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="TECH IN MY STYLE" />
    <link rel="manifest" href="./img/site.webmanifest" />

    <style>
        :root {
          --primary-light: #2196F3;
          --secondary-light: #64B5F6;
          --accent-light: #1976D2;
          --bg-light: #ffffff;
          --surface-light: rgba(255, 255, 255, 0.1);
          --text-light: #333333;
          --text-secondary-light: #666666;
          --primary-dark: #b388ff;
          --secondary-dark: #9c64ff;
          --accent-dark: #7c4dff;
          --bg-dark: #0a0a0a;
          --surface-dark: rgba(179, 136, 255, 0.1);
          --text-dark: #ffffff;
          --text-secondary-dark: #cccccc;
          
          --primary: var(--primary-light);
          --secondary: var(--secondary-light);
          --accent: var(--accent-light);
          --bg: var(--bg-light);
          --surface: var(--surface-light);
          --text: var(--text-light);
          --text-secondary: var(--text-secondary-light);
          
          --font-primary: 'Poppins', sans-serif;
          
          --spacing-xs: 0.5rem;
          --spacing-sm: 1rem;
          --spacing-md: 1.5rem;
          --spacing-lg: 2rem;
          --spacing-xl: 3rem;
          --spacing-2xl: 4rem;
          
          --radius-sm: 8px;
          --radius-md: 12px;
          --radius-lg: 16px;
          --radius-xl: 24px;
          
          --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
          --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
          --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
          --shadow-xl: 0 16px 64px rgba(0, 0, 0, 0.25);

          --gold: #FFD700; 
          --silver: #C0C0C0; 
          --bronze: #CD7F32;
        }

        [data-theme="dark"] {
          --primary: var(--primary-dark);
          --secondary: var(--secondary-dark);
          --accent: var(--accent-dark);
          --bg: var(--bg-dark);
          --surface: var(--surface-dark);
          --text: var(--text-dark);
          --text-secondary: var(--text-secondary-dark);
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: var(--font-primary);
          background: var(--bg);
          color: var(--text);
          line-height: 1.6;
          overflow-x: hidden;
          transition: all 0.3s ease;
          width: 100%;
          max-width: 100vw;
          cursor: none;
          min-height: 100vh;
        }

        .custom-cursor {
            position: fixed;
            width: 30px;
            height: 30px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            transition: width 0.2s, height 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cursor-dot {
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
        }

        a, button, .feature-card, .course-card, .scroll-top, .nav-link, .switch, .team-card, .social-item, .info-card, .user-link {
            cursor: none;
        }

        @media (max-width: 768px) {
            .custom-cursor {
                display: none;
            }
            
            body {
                cursor: auto;
            }
            
            a, button, .feature-card, .course-card, .scroll-top, .nav-link, .switch, .team-card, .social-item, .info-card, .user-link {
                cursor: pointer;
            }
        }

        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 var(--spacing-md);
          width: 100%;
        }

        #webgl-canvas {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: -1;
          pointer-events: none;
        }

        /* HEADER WITH IMPROVED DESKTOP AND MOBILE NAVIGATION */
        .header {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 1000;
          backdrop-filter: blur(20px);
          background: var(--surface);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          padding: var(--spacing-sm) 0;
          width: 100%;
          transition: all 0.3s ease;
        }

        .header .container {
          display: flex;
          justify-content: space-between;
          align-items: center;
          position: relative;
        }

        .logo h1 {
          color: var(--primary);
          font-weight: 700;
          font-size: 1.2rem;
        }

        .mobile-menu-btn {
          display: none;
          background: none;
          border: none;
          color: var(--text);
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0.5rem;
          z-index: 1001;
        }

        .nav {
          display: flex;
          gap: var(--spacing-lg);
          align-items: center;
        }

        .nav-links {
          display: flex;
          gap: var(--spacing-md);
          align-items: center;
        }

        .nav-link {
          color: var(--text);
          text-decoration: none;
          font-weight: 500;
          transition: color 0.3s ease;
          position: relative;
          padding: 0.5rem 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.3rem;
        }

        .nav-link:hover,
        .nav-link.active {
          color: var(--primary);
        }

        .nav-link::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 0;
          height: 2px;
          background: var(--primary);
          transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
          width: 100%;
        }

        .nav-link i {
          font-size: 1.2rem;
        }

        .nav-link span {
          font-size: 0.8rem;
          font-weight: 500;
        }

        .theme-toggle {
          display: flex;
          align-items: center;
          gap: var(--spacing-xs);
          position: relative;
          z-index: 1002;
        }

        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 28px;
        }

        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: var(--surface);
          transition: 0.4s;
          border-radius: 28px;
          border: 2px solid var(--primary);
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 2px;
          bottom: 2px;
          background: var(--primary);
          transition: 0.4s;
          border-radius: 50%;
        }

        input:checked + .slider:before {
          transform: translateX(22px);
        }

        .mobile-header-controls {
          display: none;
          align-items: center;
          gap: var(--spacing-sm);
        }

        /* DESKTOP NAVIGATION STYLES */
        @media (min-width: 769px) {
          .nav-links {
            gap: var(--spacing-lg);
          }
        }

        /* MOBILE NAVIGATION STYLES */
        @media (max-width: 768px) {
          .mobile-menu-btn {
            display: block;
          }

          .mobile-header-controls {
            display: flex;
          }

          .nav-links {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            background: var(--bg);
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            gap: 0;
            transition: all 0.3s ease;
            padding: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 0;
            overflow: hidden;
            z-index: 999;
          }

          .nav-links.active {
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            padding: var(--spacing-md) 0;
          }

          .nav-link {
            font-size: 1.1rem;
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: left;
            width: 100%;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0;
            background: none;
            border-radius: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            flex-direction: row;
          }

          .nav-link:last-child {
            border-bottom: none;
          }

          .nav-link:hover {
            color: var(--primary);
            background: var(--surface);
            transform: none;
            padding-left: calc(var(--spacing-lg) + var(--spacing-sm));
          }

          .nav-link.active {
            color: var(--primary);
            background: var(--surface);
            font-weight: 600;
          }

          .nav-link::after {
            display: none;
          }

          .nav .theme-toggle {
            display: none;
          }

          .logo h1 {
            font-size: 1rem;
          }

          .switch {
            width: 45px;
            height: 24px;
          }

          .slider:before {
            height: 16px;
            width: 16px;
          }

          input:checked + .slider:before {
            transform: translateX(19px);
          }
          
          /* Add icons to mobile nav links */
          .nav-link i {
            margin-right: var(--spacing-sm);
            width: 20px;
            text-align: center;
          }
        }

        /* MAIN CONTENT STYLES */
        .main-container {
          margin-top: 80px;
          min-height: calc(100vh - 80px);
          position: relative;
          z-index: 1;
          padding-bottom: 40px; /* Add bottom padding for better spacing */
        }

        .leaderboard-container {
          max-width: 980px;
          width: 100%;
          background: var(--surface);
          backdrop-filter: blur(20px);
          border-radius: var(--radius-xl);
          box-shadow: var(--shadow-xl);
          overflow: hidden;
          margin: var(--spacing-xl) auto;
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-header {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          padding: var(--spacing-2xl) var(--spacing-xl) var(--spacing-lg) var(--spacing-xl);
          text-align: center;
          position: relative;
          overflow: hidden;
        }

        .leaderboard-header::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
          animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        .leaderboard-header h1 {
          color: white;
          font-size: clamp(1.8rem, 4vw, 2.5rem);
          margin: 0 0 var(--spacing-sm);
          font-weight: 700;
          letter-spacing: 1px;
          position: relative;
          z-index: 1;
        }

        .leaderboard-header p {
          color: rgba(255, 255, 255, 0.9);
          font-size: 1rem;
          opacity: 0.9;
          margin: 0;
          position: relative;
          z-index: 1;
        }

        .controls {
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
          padding: var(--spacing-lg) var(--spacing-xl);
          background: var(--bg);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        input[type="text"], select {
          padding: var(--spacing-sm) var(--spacing-md);
          border-radius: var(--radius-sm);
          border: 2px solid var(--primary);
          font-size: 15px;
          min-width: 152px;
          outline: none;
          transition: all 0.3s ease;
          background: var(--surface);
          color: var(--text);
          backdrop-filter: blur(20px);
        }

        input[type="text"]:focus, select:focus {
          transform: translateY(-2px);
          box-shadow: var(--shadow-md);
        }

        select {
          min-width: 124px;
        }

        .spacer {
          flex: 1;
        }

        .leaderboard-table-wrap {
          overflow-x: auto;
          margin: 0 var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
          -webkit-overflow-scrolling: touch;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: var(--spacing-sm);
          background: transparent;
          font-size: 16px;
          min-width: 500px;
        }

        th {
          background: var(--primary);
          color: white;
          padding: var(--spacing-md) var(--spacing-sm);
          text-transform: uppercase;
          letter-spacing: 0.5px;
          font-size: 14px;
          font-weight: 700;
          border-bottom: none;
          user-select: none;
          position: relative;
          white-space: nowrap;
        }

        th::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 3px;
          background: linear-gradient(90deg, var(--secondary), var(--primary));
        }

        td {
          text-align: center;
          padding: var(--spacing-md) var(--spacing-sm);
          font-weight: 500;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          background: transparent;
          transition: all 0.3s ease;
          white-space: nowrap;
        }

        td.user-cell {
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
          justify-content: flex-start;
          text-align: left;
          white-space: nowrap;
        }

        .rank-medal {
          font-size: 1.23rem;
          user-select: none;
        }

        .gold { color: var(--gold); }
        .silver { color: var(--silver); }
        .bronze { color: var(--bronze); }

        tr.top-row {
          font-weight: 700;
          background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05)) !important;
          border-left: 4px solid var(--gold);
        }

        tr:hover td {
          background: var(--surface);
          transform: translateX(5px);
        }

        .user-link {
          color: var(--primary);
          text-decoration: none;
          font-weight: 600;
          border-bottom: 2px dashed var(--primary);
          transition: all 0.3s ease;
          padding: var(--spacing-xs) 0;
        }

        .user-link:hover {
          color: var(--secondary);
          border-bottom: 2px solid var(--secondary);
          transform: translateY(-2px);
        }

        .avatar {
          width: 38px;
          height: 38px;
          background: var(--primary);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: white;
          font-size: 1.17rem;
          user-select: none;
          border: 2px solid var(--surface);
          box-shadow: var(--shadow-sm);
          transition: all 0.3s ease;
        }

        .avatar:hover {
          transform: scale(1.1);
          box-shadow: var(--shadow-md);
        }

        /* Chart container styling */
        .chart-container {
          width: 90%;
          height: 250px; /* Fixed height for the chart */
          margin: 0 auto var(--spacing-xl) auto;
          background: var(--surface);
          backdrop-filter: blur(10px);
          border-radius: var(--radius-md);
          padding: var(--spacing-md);
          box-shadow: var(--shadow-md);
          border: 1px solid rgba(255, 255, 255, 0.1);
          overflow: hidden;
        }

        #scoreChart {
          width: 100% !important;
          height: 100% !important;
          max-height: 100%;
        }

        .back-btn {
          margin: var(--spacing-lg) var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
          display: block;
          width: auto;
          padding: var(--spacing-md) var(--spacing-xl);
          font-size: 15px;
          border-radius: var(--radius-md);
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: white;
          font-weight: 600;
          border: none;
          cursor: pointer;
          letter-spacing: 0.2px;
          transition: all 0.3s ease;
          user-select: none;
          box-shadow: var(--shadow-md);
          position: relative;
          overflow: hidden;
        }

        .back-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
          transition: left 0.5s;
        }

        .back-btn:hover::before {
          left: 100%;
        }

        .back-btn:hover {
          transform: translateY(-3px);
          box-shadow: var(--shadow-lg);
        }

        .chart-card, .modal-table-wrap, .modal-chart-wrap {
          background: var(--surface);
          backdrop-filter: blur(20px);
          border-radius: var(--radius-md);
          box-shadow: var(--shadow-md);
          padding: var(--spacing-lg) var(--spacing-md);
          margin-bottom: var(--spacing-lg);
          border: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        #progressModal {
          display: none;
          position: fixed;
          z-index: 10000;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.8);
          align-items: center;
          justify-content: center;
          padding: var(--spacing-md);
          overflow-y: auto;
          backdrop-filter: blur(10px);
        }

        #progressModal > div {
          background: var(--bg);
          border-radius: var(--radius-xl);
          padding: var(--spacing-2xl) var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
          max-width: 950px;
          width: 100%;
          max-height: 85vh;
          box-shadow: var(--shadow-xl);
          display: flex;
          gap: var(--spacing-2xl);
          color: var(--text);
          position: relative;
          flex-direction: column;
          align-items: stretch;
          border: 2px solid var(--primary);
          overflow-y: auto; /* Allow scrolling */
        }

        #modalUser {
          font-weight: 600;
          font-size: 1.5rem;
          color: var(--primary);
          margin-bottom: var(--spacing-lg);
          text-align: center;
        }

        .closeModalBtn {
          position: absolute;
          top: var(--spacing-md);
          right: var(--spacing-lg);
          font-size: 24px;
          background: var(--surface);
          border: 2px solid var(--primary);
          cursor: pointer;
          color: var(--primary);
          z-index: 10;
          user-select: none;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
        }

        .closeModalBtn:hover {
          background: var(--primary);
          color: white;
          transform: rotate(90deg);
        }

        .modal-content-bottom {
          display: flex;
          flex-wrap: wrap;
          gap: var(--spacing-xl);
          justify-content: center;
        }

        .modal-table-wrap, .modal-chart-wrap, .chart-card {
          flex: 1 1 300px;
          min-width: 280px;
          max-width: 400px;
        }

        .modal-summary {
          flex: 1 1 300px;
          min-width: 280px;
          max-width: 400px;
          display: flex;
          flex-direction: column;
          align-items: stretch;
        }

        #progressTable, #courseSummaryTable {
          width: 100%;
          border-collapse: separate;
          border-spacing: 0 8px;
          font-size: 15px;
          background: var(--bg);
          border-radius: var(--radius-md);
          box-shadow: var(--shadow-sm);
          overflow: hidden;
          margin-bottom: var(--spacing-md);
        }

        #progressTable th, #progressTable td, #courseSummaryTable th, #courseSummaryTable td {
          padding: var(--spacing-md) var(--spacing-lg);
          text-align: center;
          background-color: var(--surface);
          border-bottom: none;
          font-weight: 600;
          color: var(--text);
        }

        #progressTable th, #courseSummaryTable th {
          background: var(--primary);
          color: white;
          user-select: none;
        }

        #courseSummarySelect {
          font-size: 15px;
          border-radius: var(--radius-sm);
          border: 2px solid var(--primary);
          appearance: none;
          cursor: pointer;
          margin-bottom: var(--spacing-md);
          padding: var(--spacing-sm) var(--spacing-md);
          width: 100%;
          user-select: none;
          background: var(--surface);
          color: var(--text);
        }

        #courseSummaryTable {
          margin-top: var(--spacing-sm);
        }

        .chart-card canvas {
          width: 100% !important;
          background: transparent !important;
          max-height: 300px;
        }

        /* RESPONSIVE FIXES FOR ALL SCREEN SIZES */
        @media (max-width: 1200px) {
          .leaderboard-container {
            margin: var(--spacing-lg) var(--spacing-md);
          }
          
          .chart-container {
            width: calc(100% - 40px);
          }
        }

        @media (max-width: 992px) {
          .leaderboard-container {
            margin: var(--spacing-md);
          }
          
          .leaderboard-header {
            padding: var(--spacing-xl) var(--spacing-lg);
          }
          
          .chart-container {
            height: 220px;
          }
        }

        @media (max-width: 768px) {
          .main-container {
            margin-top: 70px;
          }

          .leaderboard-container {
            margin: var(--spacing-sm);
            border-radius: var(--radius-lg);
          }

          .leaderboard-header {
            padding: var(--spacing-lg) var(--spacing-md);
          }

          .controls {
            flex-direction: column;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
          }

          .controls > * {
            width: 100%;
          }

          .leaderboard-table-wrap {
            margin: 0 var(--spacing-sm) var(--spacing-md) var(--spacing-sm);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
          }

          table {
            font-size: 14px;
            min-width: 400px;
          }

          th, td {
            padding: var(--spacing-sm);
          }

          .back-btn {
            margin: var(--spacing-sm);
            text-align: center;
            width: calc(100% - var(--spacing-sm) * 2);
          }

          td.user-cell {
            gap: var(--spacing-sm);
          }

          .avatar {
            width: 32px;
            height: 32px;
            font-size: 1rem;
          }
          
          .chart-container {
            width: calc(100% - 20px);
            height: 200px;
            margin: 0 auto var(--spacing-md) auto;
          }

          #progressModal > div {
            max-height: 90vh;
            padding: var(--spacing-md);
            gap: var(--spacing-md);
            width: 95%;
            border-radius: var(--radius-lg);
          }

          .modal-content-bottom {
            flex-direction: column;
            gap: var(--spacing-md);
          }

          .modal-table-wrap, .modal-chart-wrap, .chart-card, .modal-summary {
            flex: none;
            min-width: auto;
            max-width: none;
            width: 100%;
          }
        }

        @media (max-width: 576px) {
          .leaderboard-table-wrap {
            margin: 0 var(--spacing-xs) var(--spacing-sm) var(--spacing-xs);
          }

          table {
            font-size: 13px;
            min-width: 350px;
          }

          th, td {
            padding: var(--spacing-xs);
          }

          .controls {
            padding: var(--spacing-sm);
          }
          
          .chart-container {
            height: 180px;
          }

          #progressModal > div {
            padding: var(--spacing-sm);
          }

          .modal-content-bottom {
            gap: var(--spacing-sm);
          }
        }

        @media (max-width: 480px) {
          .leaderboard-container {
            margin: var(--spacing-xs);
            border-radius: var(--radius-md);
          }

          .leaderboard-header {
            padding: var(--spacing-md);
          }

          .leaderboard-header h1 {
            font-size: 1.5rem;
          }

          .leaderboard-header p {
            font-size: 0.9rem;
          }

          table {
            font-size: 12px;
            min-width: 300px;
          }

          .avatar {
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
          }

          .controls {
            padding: var(--spacing-xs);
          }

          .back-btn {
            margin: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 14px;
          }
          
          .chart-container {
            height: 160px;
            padding: var(--spacing-sm);
          }

          #progressModal > div {
            padding: var(--spacing-xs);
          }
        }

        @media (max-width: 380px) {
          .leaderboard-header h1 {
            font-size: 1.3rem;
          }

          .leaderboard-header p {
            font-size: 0.8rem;
          }

          table {
            font-size: 11px;
            min-width: 280px;
          }

          th, td {
            padding: 4px;
          }
          
          .chart-container {
            height: 150px;
          }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Custom Cursor -->
    <div class="custom-cursor">
        <div class="cursor-dot"></div>
    </div>

    <!-- WebGL Background -->
    <canvas id="webgl-canvas"></canvas>

    <!-- Header with Navigation -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>üèÜ Tech Leaderboard</h1>
            </div>
            <nav class="nav">
                <div class="nav-links" id="navLinks">
                    <a href="/" class="nav-link active">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="/courses" class="nav-link">
                        <i class="fas fa-book"></i>
                        <span>Courses</span>
                    </a>
                    <a href="/about-us" class="nav-link">
                        <i class="fas fa-info-circle"></i>
                        <span>About Us</span>
                    </a>
                    <a href="/stay-connected" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>Stay Connected </span>
                    </a>
                                        <a href="/feedback" class="nav-link">
                        <i class="fas fa-comment"></i>
                        <span>Feedback Center</span>
                    </a>
                    <a href="/leaderboard" class="nav-link">
                        <i class="fas fa-trophy"></i>
                        <span>Leaderboard</span>
                    </a>
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-arrow-right-from-bracket"></i>
                        <span>Logout</span>
                    </a>
                </div>

                <div class="theme-toggle">
                    <label class="switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </nav>
            <div class="mobile-header-controls">
                <div class="theme-toggle">
                    <label class="switch">
                        <input type="checkbox" id="mobileThemeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <div class="container">
            <div class="leaderboard-container" role="main">
                <section class="leaderboard-header">
                    <h1>üèÜ Leaderboard</h1>
                    <p>Click a username for full course progress details.</p>
                </section>
                
                <section class="controls" aria-label="Search and filter leaderboard">
                    <input type="text" id="searchInput" aria-label="Search user" placeholder="üîç Search user..." />
                    <select id="sortSelect" aria-label="Sort leaderboard">
                        <option value="rank">Sort by Rank</option>
                        <option value="score">Sort by Score</option>
                        <option value="user">Sort by Username</option>
                    </select>
                    <span class="spacer" aria-hidden="true"></span>
                </section>
                
                <section class="leaderboard-table-wrap" aria-label="Leaderboard table">
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Rank</th>
                                <th scope="col">User</th>
                                <th scope="col">Total Tasks</th>
                            </tr>
                        </thead>
                        <tbody id="board" role="rowgroup"></tbody>
                    </table>
                </section>
                
                <!-- Chart container for better styling and visibility -->
                <div class="chart-container">
                    <canvas id="scoreChart" aria-label="Bar chart of total tasks completed by users"></canvas>
                </div>
                
                <button class="back-btn" onclick="goHome()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>
        </div>
    </main>

    <!-- Modal for user progress -->
    <div id="progressModal" role="dialog" aria-modal="true" aria-labelledby="modalUser" tabindex="-1">
        <div>
            <button class="closeModalBtn" onclick="closeModal()" aria-label="Close modal">&times;</button>
            <div id="modalUser" aria-live="polite">User Progress</div>
            <div class="modal-content-bottom">
                <div class="modal-table-wrap chart-card">
                    <table id="progressTable" aria-label="Course-wise progress table" hidden>
                        <thead><tr><th>Course Name</th><th>Tasks Completed</th></tr></thead>
                        <tbody id="progressTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-chart-wrap chart-card">
                    <canvas id="userProgressChart"></canvas>
                </div>
                <div class="modal-summary chart-card">
                    <select id="courseSummarySelect" aria-label="Select course for summary"></select>
                    <table id="courseSummaryTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Completed</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="summaryCourse">&ndash;</td>
                                <td id="summaryCompleted">0</td>
                                <td id="summaryTotal">0</td>
                            </tr>
                        </tbody>
                    </table>
                    <canvas id="courseSummaryPie"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Improved WebGL Background with better performance
        class ParticleSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = [];
                this.particleCount = window.innerWidth < 768 ? 15 : 20; // Reduce for mobile
                this.mouse = { x: 0, y: 0 };
                this.animationId = null;
                this.active = true;
                
                this.resizeCanvas();
                this.createParticles();
                this.bindEvents();
                this.animate();
            }

            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            createParticles() {
                this.particles = []; // Clear existing particles
                for (let i = 0; i < this.particleCount; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        size: Math.random() * 15 + 15, // Adjusted size for better visibility
                        speedX: (Math.random() - 0.5) * 0.3, // Slower movement
                        speedY: (Math.random() - 0.5) * 0.3,
                        color: this.getRandomColor(),
                        opacity: Math.random() * 0.3 + 0.1
                    });
                }
            }

            getRandomColor() {
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                const baseColor = isDark ? '179, 136, 255' : '33, 150, 243';
                return `rgba(${baseColor}, ${Math.random() * 0.2 + 0.1})`;
            }

            updateParticles() {
                this.particles.forEach(particle => {
                    particle.x += particle.speedX;
                    particle.y += particle.speedY;
                    
                    // Bounce off edges with a small buffer
                    if (particle.x <= 0 || particle.x >= this.canvas.width) {
                        particle.speedX *= -1;
                        // Move slightly away from the edge to prevent sticking
                        particle.x = particle.x <= 0 ? 1 : this.canvas.width - 1;
                    }
                    if (particle.y <= 0 || particle.y >= this.canvas.height) {
                        particle.speedY *= -1;
                        // Move slightly away from the edge to prevent sticking
                        particle.y = particle.y <= 0 ? 1 : this.canvas.height - 1;
                    }
                    
                    // Mouse interaction - simplified for performance
                    if (this.mouse.x && this.mouse.y) { // Only if mouse has moved
                        const dx = this.mouse.x - particle.x;
                        const dy = this.mouse.y - particle.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 150) {
                            const force = (150 - distance) / 1500;
                            particle.x -= dx * force;
                            particle.y -= dy * force;
                        }
                    }
                });
            }

            render() {
                // Clear canvas with semi-transparent background for trail effect
                this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg');
                this.ctx.globalAlpha = 0.2; // Increased for better visibility
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.globalAlpha = 1;
                
                // Draw particles
                this.particles.forEach(particle => {
                    this.ctx.save();
                    this.ctx.translate(particle.x, particle.y);
                    
                    // Draw square particles with rounded corners
                    this.ctx.fillStyle = particle.color;
                    this.ctx.globalAlpha = particle.opacity;
                    this.roundRect(this.ctx, -particle.size/2, -particle.size/2, 
                                  particle.size, particle.size, 4);
                    this.ctx.fill();
                    
                    // Draw inner square (second ring)
                    const isDark = document.body.getAttribute('data-theme') === 'dark';
                    const innerColor = isDark ? '179, 136, 255' : '33, 150, 243';
                    this.ctx.fillStyle = `rgba(${innerColor}, 0.3)`;
                    this.ctx.globalAlpha = particle.opacity * 2;
                    this.roundRect(this.ctx, -particle.size/4, -particle.size/4, 
                                  particle.size/2, particle.size/2, 2);
                    this.ctx.fill();
                    
                    this.ctx.restore();
                });
            }

            // Helper for rounded rectangles
            roundRect(ctx, x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.arcTo(x + width, y, x + width, y + height, radius);
                ctx.arcTo(x + width, y + height, x, y + height, radius);
                ctx.arcTo(x, y + height, x, y, radius);
                ctx.arcTo(x, y, x + width, y, radius);
                ctx.closePath();
            }

            bindEvents() {
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                    this.createParticles(); // Recreate on resize
                });
                
                // Throttle mousemove for performance
                let mouseTimeout;
                window.addEventListener('mousemove', (e) => {
                    if (mouseTimeout) return;
                    mouseTimeout = setTimeout(() => {
                        this.mouse.x = e.clientX;
                        this.mouse.y = e.clientY;
                        mouseTimeout = null;
                    }, 16); // ~60fps
                });
                
                // Update colors when theme changes
                const observer = new MutationObserver(() => {
                    this.particles.forEach(particle => {
                        particle.color = this.getRandomColor();
                    });
                });
                
                observer.observe(document.body, { attributes: true, attributeFilter: ['data-theme'] });
                
                // Pause animation when page is not visible to save resources
                document.addEventListener('visibilitychange', () => {
                    this.active = document.visibilityState === 'visible';
                    if (this.active && !this.animationId) {
                        this.animate();
                    }
                });
            }

            animate() {
                if (!this.active) {
                    this.animationId = null;
                    return;
                }
                
                this.updateParticles();
                this.render();
                this.animationId = requestAnimationFrame(() => this.animate());
            }

            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                this.active = false;
                this.particles = [];
            }
        }

        // Custom Cursor with improved performance
        class CustomCursor {
            constructor() {
                this.cursor = document.querySelector('.custom-cursor');
                this.cursorVisible = true;
                this.cursorEnabled = window.innerWidth > 768;
                this.bindEvents();
            }

            bindEvents() {
                // Only enable cursor on desktop
                if (!this.cursorEnabled) {
                    this.cursor.style.display = 'none';
                    return;
                }
                
                // Throttled mousemove for better performance
                let lastX = 0;
                let lastY = 0;
                let rafId = null;
                
                document.addEventListener('mousemove', (e) => {
                    lastX = e.clientX;
                    lastY = e.clientY;
                    
                    // Show cursor
                    if (!this.cursorVisible) {
                        this.cursor.style.opacity = '1';
                        this.cursorVisible = true;
                    }
                    
                    // Throttle updates with requestAnimationFrame
                    if (!rafId) {
                        rafId = requestAnimationFrame(() => {
                            this.cursor.style.transform = `translate(${lastX}px, ${lastY}px)`;
                            rafId = null;
                        });
                    }
                });

                // Mouse events
                document.addEventListener('mousedown', () => {
                    if (this.cursorEnabled) {
                        this.cursor.style.width = '25px';
                        this.cursor.style.height = '25px';
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (this.cursorEnabled) {
                        this.cursor.style.width = '30px';
                        this.cursor.style.height = '30px';
                    }
                });
                
                // Hide cursor when leaving window
                document.addEventListener('mouseout', (e) => {
                    if (e.relatedTarget === null) {
                        this.cursor.style.opacity = '0';
                        this.cursorVisible = false;
                    }
                });
                
                // Check for window resize
                window.addEventListener('resize', () => {
                    this.cursorEnabled = window.innerWidth > 768;
                    this.cursor.style.display = this.cursorEnabled ? 'flex' : 'none';
                });
            }
        }

        // Mobile Navigation with improved functionality
        class MobileNavigation {
            constructor() {
                this.mobileMenuBtn = document.getElementById('mobileMenuBtn');
                this.navLinks = document.getElementById('navLinks');
                this.isOpen = false;
                this.bindEvents();
            }

            bindEvents() {
                this.mobileMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleMenu();
                });

                // Close menu when clicking on a link
                this.navLinks.addEventListener('click', (e) => {
                    if (e.target.classList.contains('nav-link')) {
                        this.closeMenu();
                    }
                });

                // Close menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (this.isOpen && !this.mobileMenuBtn.contains(e.target) && 
                        !this.navLinks.contains(e.target)) {
                        this.closeMenu();
                    }
                });
                
                // Close on escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isOpen) {
                        this.closeMenu();
                    }
                });
                
                // Handle resize events
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 768 && this.isOpen) {
                        this.closeMenu();
                    }
                });
            }

            toggleMenu() {
                this.isOpen = !this.isOpen;
                this.navLinks.classList.toggle('active');
                const icon = this.mobileMenuBtn.querySelector('i');
                icon.classList.toggle('fa-bars');
                icon.classList.toggle('fa-times');
                
                // Prevent body scrolling when menu is open
                document.body.style.overflow = this.isOpen ? 'hidden' : '';
            }

            closeMenu() {
                if (!this.isOpen) return;
                
                this.isOpen = false;
                this.navLinks.classList.remove('active');
                const icon = this.mobileMenuBtn.querySelector('i');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
                
                // Restore body scrolling
                document.body.style.overflow = '';
            }
        }

        // Theme Toggle with improved functionality
        class ThemeToggle {
            constructor() {
                this.themeToggle = document.getElementById('themeToggle');
                this.mobileThemeToggle = document.getElementById('mobileThemeToggle');
                this.bindEvents();
                this.loadTheme();
            }

            bindEvents() {
                this.themeToggle.addEventListener('change', () => {
                    this.toggleTheme();
                });

                this.mobileThemeToggle.addEventListener('change', () => {
                    this.toggleTheme();
                });
                
                // Listen for system preference changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (localStorage.getItem('theme') === null) {
                        // Only auto-switch if user hasn't manually set a preference
                        const newTheme = e.matches ? 'dark' : 'light';
                        document.body.setAttribute('data-theme', newTheme);
                        const isDark = newTheme === 'dark';
                        this.themeToggle.checked = isDark;
                        this.mobileThemeToggle.checked = isDark;
                    }
                });
            }

            toggleTheme() {
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Sync both toggles
                const isDark = newTheme === 'dark';
                this.themeToggle.checked = isDark;
                this.mobileThemeToggle.checked = isDark;
                
                // Refresh charts if they exist
                if (window.scoreChart) {
                    window.scoreChart.update();
                }
                if (window.progressChartInstance) {
                    window.progressChartInstance.update();
                }
                if (window.courseSummaryPieInstance) {
                    window.courseSummaryPieInstance.update();
                }
            }

            loadTheme() {
                // Check for saved theme or use system preference
                let savedTheme = localStorage.getItem('theme');
                
                if (!savedTheme) {
                    // Use system preference if no saved theme
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    savedTheme = prefersDark ? 'dark' : 'light';
                }
                
                document.body.setAttribute('data-theme', savedTheme);
                const isDark = savedTheme === 'dark';
                this.themeToggle.checked = isDark;
                this.mobileThemeToggle.checked = isDark;
            }
        }

        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Initialize components
        document.addEventListener('DOMContentLoaded', () => {
            const particleSystem = new ParticleSystem(document.getElementById('webgl-canvas'));
            new CustomCursor();
            new MobileNavigation();
            new ThemeToggle();
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                particleSystem.destroy();
            });
        });

        // LEADERBOARD FUNCTIONALITY WITH FIXES FOR CHART RENDERING
        let leaderboardData = [];
        let courseTotals = {};
        let currentUserProgress = null;
        let progressChartInstance = null;
        let courseSummaryPieInstance = null;
        let scoreChart = null;

        const medals = [
            '<span class="rank-medal gold">ü•á</span>',
            '<span class="rank-medal silver">ü•à</span>',
            '<span class="rank-medal bronze">ü•â</span>'
        ];

        // Helper: get user's initials
        function getInitials(name) {
            if (!name) return "U";
            const parts = name.split(/[ ._]/).filter(Boolean);
            return parts.length === 1 ? parts[0][0].toUpperCase() : (parts[0][0] + parts[1][0]).toUpperCase();
        }

        function renderTable(data) {
            const tbody = document.getElementById("board");
            tbody.innerHTML = "";
            
            // Use document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            data.forEach((userData, i) => {
                const tr = document.createElement('tr');
                if (i < 3) tr.classList.add('top-row');
                
                tr.innerHTML = `
                  <td>${i < 3 ? medals[i] : (i + 1)}</td>
                  <td class="user-cell">
                    <span class="avatar">${getInitials(userData.user)}</span>
                    <a href="#" class="user-link" data-username="${userData.user}" tabindex="0">${userData.user}</a>
                  </td>
                  <td>${userData.score}</td>
                `;
                
                fragment.appendChild(tr);
            });
            
            tbody.appendChild(fragment);
        }

        // Create the chart with proper configuration
        function updateChart(data) {
            const chartCtx = document.getElementById('scoreChart').getContext('2d');
            const labels = data.map(u => u.user);
            const scores = data.map(u => u.score);
            
            // Destroy existing chart if it exists
            if (scoreChart) {
                scoreChart.destroy();
                scoreChart = null;
            }
            
            // Set primary color
            const primaryColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--primary').trim();
            
            // Register Chart.js plugins
            Chart.register(ChartDataLabels);
            
            // Create new chart
            scoreChart = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Tasks Completed',
                        data: scores,
                        backgroundColor: primaryColor,
                        borderColor: primaryColor,
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.7,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20
                        }
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        datalabels: {
                            color: 'white',
                            anchor: 'end',
                            align: 'top',
                            font: {
                                weight: 'bold'
                            },
                            formatter: v => v,
                            padding: 6
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: primaryColor,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 10,
                            cornerRadius: 6,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Debounced search and sort
        const debouncedSearchAndSort = debounce(applySearchAndSort, 300);

        function applySearchAndSort() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const sortValue = document.getElementById('sortSelect').value;
            let filtered = leaderboardData.filter(u => u.user.toLowerCase().includes(searchTerm));
            
            if(sortValue === "user") {
                filtered.sort((a,b) => a.user.localeCompare(b.user));
            } else if(sortValue === "score") {
                filtered.sort((a,b) => b.score - a.score);
            } else { //rank
                filtered.sort((a,b) => b.score - a.score);
            }
            
            renderTable(filtered);
            updateChart(filtered);
        }

        async function loadCourseTotals() {
            try {
                const res = await fetch('https://tech-trail-w2ap.onrender.com/courses/meta');
                if(!res.ok) throw new Error("Failed to fetch course totals");
                courseTotals = await res.json();
            } catch(err) {
                console.error("Error loading course totals:", err);
                courseTotals = {
                    "ai": 30,"ml":30,"dl":30,"java":30,"c":30,"html":30,
                    "css":30,"js":30,"js-intermediate":30,"python":30,"dsc":30
                };
            }
        }

        async function loadBoard() {
            await loadCourseTotals();
            try {
                const res = await fetch('https://tech-trail-w2ap.onrender.com/leaderboard');
                if (!res.ok) throw new Error("Failed to fetch leaderboard");
                leaderboardData = await res.json();
                
                // If leaderboard is empty, add some example data
                if (!leaderboardData || leaderboardData.length === 0) {
                    leaderboardData = [
                        { user: "JohnDoe", score: 120 },
                        { user: "AliceSmith", score: 115 },
                        { user: "BobJohnson", score: 98 },
                        { user: "SarahWilliams", score: 85 },
                        { user: "MikeRobinson", score: 72 }
                    ];
                }
                
                applySearchAndSort();
            } catch(e) {
                console.error("Error loading leaderboard:", e);
                
                // Show an error message
                document.getElementById("board").innerHTML = `
                    <tr><td colspan="3">
                        <div style="padding: 20px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--primary); font-size: 24px;"></i>
                            <p style="margin-top: 10px;">Failed to load leaderboard data. Please try again later.</p>
                        </div>
                    </td></tr>
                `;
                
                // Create example data for demonstration
                leaderboardData = [
                    { user: "JohnDoe", score: 120 },
                    { user: "AliceSmith", score: 115 },
                    { user: "BobJohnson", score: 98 },
                    { user: "SarahWilliams", score: 85 },
                    { user: "MikeRobinson", score: 72 }
                ];
                
                // Still attempt to render the chart with example data
                updateChart(leaderboardData);
            }
        }

        function goHome() {
            window.location.href = "../index.html";
        }

        function closeModal() {
            if(progressChartInstance) { 
                progressChartInstance.destroy(); 
                progressChartInstance = null;
            }
            if(courseSummaryPieInstance) { 
                courseSummaryPieInstance.destroy(); 
                courseSummaryPieInstance = null;
            }
            const modal = document.getElementById('progressModal');
            if(modal) modal.style.display = 'none';
            
            // Re-enable scrolling on body
            document.body.style.overflow = '';
        }

        function renderProgressChart() {
            if (!currentUserProgress) return;
            const ctx = document.getElementById('userProgressChart').getContext('2d');
            
            if(progressChartInstance) { 
                progressChartInstance.destroy(); 
                progressChartInstance = null;
            }
            
            const labels = Object.keys(currentUserProgress);
            const data = labels.map(c => currentUserProgress[c]?.length || 0);
            
            // Vibrant color palette that works in both light and dark mode
            const bgColors = [
                '#3574e6','#56b881','#ef476f','#ffd166',
                '#06d6a0','#118ab2','#b388eb','#f78fb3'
            ];
            
            progressChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.length ? labels : ['No Progress'],
                    datasets: [{
                        data: data.length ? data : [1],
                        backgroundColor: bgColors.slice(0, labels.length || 1),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    },
                    plugins: {
                        legend: {
                            display: true, 
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold', 
                                size: 12
                            },
                            formatter: (value, context) => {
                                const {dataset} = context;
                                const total = dataset.data.reduce((a,b) => a+b, 0) || 1;
                                const percentage = ((value/total)*100).toFixed(1);
                                return percentage > 5 ? `${percentage}%` : ''; // Hide small slices
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            padding: 10,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function updateCourseSummaryDropdown() {
            const select = document.getElementById('courseSummarySelect');
            select.innerHTML = '';
            
            // Sort courses alphabetically
            const sortedCourses = Object.keys(courseTotals).sort();
            
            sortedCourses.forEach(course => {
                const opt = document.createElement('option');
                opt.value = course;
                opt.textContent = course;
                select.appendChild(opt);
            });
            
            if(sortedCourses.length > 0) {
                select.value = sortedCourses[0];
            }
        }

        function updateCourseSummary(course) {
            if (!currentUserProgress || !courseTotals[course]) {
                document.getElementById('courseSummaryTable').style.display = 'none';
                if (courseSummaryPieInstance) { 
                    courseSummaryPieInstance.destroy(); 
                    courseSummaryPieInstance = null; 
                }
                return;
            }
            
            document.getElementById('courseSummaryTable').style.display = '';
            const total = courseTotals[course] ?? 0;
            const completed = (currentUserProgress && currentUserProgress[course]) ? 
                              currentUserProgress[course].length : 0;
            
            document.getElementById('summaryCourse').textContent = course;
            document.getElementById('summaryTotal').textContent = total;
            document.getElementById('summaryCompleted').textContent = completed;
            
            const ctx = document.getElementById('courseSummaryPie').getContext('2d');
            
            if (courseSummaryPieInstance) {
                courseSummaryPieInstance.destroy();
            }
            
            courseSummaryPieInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{
                        data: [completed, Math.max(total-completed, 0)],
                        backgroundColor: ['#56b881', '#dbdef8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 800
                    },
                    plugins: {
                        legend: {
                            display: true, 
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        },
                        datalabels: {
                            color: (context) => {
                                // Make label text visible against background
                                return context.dataIndex === 0 ? '#fff' : '#333';
                            },
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                if (total === 0) return '';
                                const percentage = ((value/total)*100).toFixed(0);
                                return percentage > 5 ? `${percentage}%` : '';
                            }
                        },
                                                tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            padding: 10,
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        async function loadUserProgress(username) {
            const modal = document.getElementById('progressModal');
            if (!modal) return alert("Modal element not found.");
            
            const modalUser = document.getElementById('modalUser');
            modalUser.textContent = `Course Progress for ${username}`;
            modal.style.display = 'flex';
            
            // Disable scrolling on body when modal is open
            document.body.style.overflow = 'hidden';
            
            // Reset previous data
            currentUserProgress = null;
            const progressTable = document.getElementById('progressTable');
            const progressTableBody = document.getElementById('progressTableBody');
            progressTable.hidden = true;
            progressTableBody.innerHTML = '<tr><td colspan="2" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            
            if (progressChartInstance) { 
                progressChartInstance.destroy(); 
                progressChartInstance = null;
            }
            if (courseSummaryPieInstance) { 
                courseSummaryPieInstance.destroy(); 
                courseSummaryPieInstance = null;
            }
            
            document.getElementById('courseSummarySelect').innerHTML = '';
            document.getElementById('courseSummaryTable').style.display = 'none';
            
            try {
                const res = await fetch(`https://tech-trail-w2ap.onrender.com/progress/${encodeURIComponent(username)}`);
                
                if (!res.ok) {
                    throw new Error(`Failed to fetch user progress: ${res.status}`);
                }
                
                const prog = await res.json();
                currentUserProgress = prog;
                const courses = Object.keys(prog);
                
                if (courses.length === 0) {
                    progressTableBody.innerHTML = `
                        <tr>
                            <td colspan="2" style="text-align:center;">
                                <i class="fas fa-info-circle"></i> No task progress found for this user.
                            </td>
                        </tr>
                    `;
                } else {
                    // Sort courses by completion count (descending)
                    courses.sort((a, b) => prog[b].length - prog[a].length);
                    
                    progressTableBody.innerHTML = courses.map(course => {
                        const taskCount = prog[course].length;
                        const total = courseTotals[course] || 0;
                        const percentage = total > 0 ? ((taskCount / total) * 100).toFixed(1) : 0;
                        
                        return `
                            <tr>
                                <td>${course}</td>
                                <td>${taskCount}${total ? ` / ${total} (${percentage}%)` : ''}</td>
                            </tr>
                        `;
                    }).join('');
                }
                
                progressTable.hidden = false;
                renderProgressChart();
                updateCourseSummaryDropdown();
                
                const dropdown = document.getElementById('courseSummarySelect');
                dropdown.onchange = (e) => updateCourseSummary(e.target.value);
                
                if (dropdown.value) {
                    updateCourseSummary(dropdown.value);
                }
            } catch (e) {
                console.error('Error loading user progress:', e);
                
                progressTableBody.innerHTML = `
                    <tr>
                        <td colspan="2" style="color:#ea5252; text-align:center;">
                            <i class="fas fa-exclamation-circle"></i> Failed to load progress data.
                            <br><small>Please try again later.</small>
                        </td>
                    </tr>
                `;
                progressTable.hidden = false;
                
                // Create some example data for demonstration
                currentUserProgress = {
                    "html": [1, 2, 3, 4, 5],
                    "css": [1, 2, 3],
                    "js": [1, 2, 3, 4],
                    "python": [1, 2]
                };
                
                renderProgressChart();
                updateCourseSummaryDropdown();
                
                const dropdown = document.getElementById('courseSummarySelect');
                dropdown.onchange = (e) => updateCourseSummary(e.target.value);
                
                if (dropdown.value) {
                    updateCourseSummary(dropdown.value);
                }
            }
        }

        // Event Listeners
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('user-link')) {
                e.preventDefault();
                loadUserProgress(e.target.getAttribute('data-username'));
            }
        });

        document.getElementById("searchInput").addEventListener("input", debouncedSearchAndSort);
        document.getElementById("sortSelect").addEventListener("change", applySearchAndSort);

        document.addEventListener("keydown", function(e) {
            if (document.getElementById('progressModal').style.display === 'flex') {
                if (e.key === "Escape") { 
                    closeModal(); 
                }
            }
        });

        // Close modal when clicking outside of modal content
        document.getElementById('progressModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Load leaderboard data
        window.addEventListener('load', function() {
            loadBoard();
        });
        
        function logout() {
            // Example logout functionality - replace with actual implementation
            alert('Logout functionality would go here.');
            // window.location.href = "/login.html";
        }

        // Implement a resize observer for chart responsiveness
        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                if (entry.target.classList.contains('chart-container') && scoreChart) {
                    // Give the container time to resize before updating chart
                    setTimeout(() => {
                        scoreChart.resize();
                        scoreChart.update();
                    }, 100);
                }
            }
        });

        // Start observing the chart container
        document.querySelectorAll('.chart-container').forEach(container => {
            resizeObserver.observe(container);
        });

        // Make sure the chart renders correctly on theme change
        document.querySelectorAll('#themeToggle, #mobileThemeToggle').forEach(toggle => {
            toggle.addEventListener('change', () => {
                // Update charts when theme changes
                if (scoreChart) {
                    setTimeout(() => {
                        scoreChart.update();
                    }, 100);
                }
                
                if (progressChartInstance) {
                    setTimeout(() => {
                        progressChartInstance.update();
                    }, 100);
                }
                
                if (courseSummaryPieInstance) {
                    setTimeout(() => {
                        courseSummaryPieInstance.update();
                    }, 100);
                }
            });
        });
        
        // Handle visibility change to optimize performance
        document.addEventListener('visibilitychange', () => {
            // Pause animations when page is not visible
            if (document.visibilityState === 'hidden') {
                if (scoreChart) {
                    scoreChart.options.animation = false;
                }
            } else {
                // Resume animations when page becomes visible again
                if (scoreChart) {
                    scoreChart.options.animation = {
                        duration: 750,
                        easing: 'easeOutQuart'
                    };
                }
            }
        });

        // Disable right click and dev tools (preserved from original)
        document.addEventListener("contextmenu", (e) => e.preventDefault());

        document.onkeydown = function(e) {
            // Disable F12
            if (e.keyCode === 123) return false;

            // Disable Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C
            if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) {
                return false;
            }

            // Disable Ctrl+U (View Source)
            if (e.ctrlKey && e.keyCode === 85) return false;

            // Disable Ctrl+S (Save Page)
            if (e.ctrlKey && e.keyCode === 83) return false;

            // Disable Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+P
            if (e.ctrlKey && (e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86 || e.keyCode === 80)) {
                return false;
            }

            // Disable Ctrl+Shift+K (Firefox)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 75) return false;
        };
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7G01YFBCVB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7G01YFBCVB');
    </script>
</body>
</html>
                        
