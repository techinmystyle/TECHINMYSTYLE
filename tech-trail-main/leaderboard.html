<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Leaderboard - Tech In My Style</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- Chart.js and Data Labels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="tech-no bg.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">
    <link rel="icon" type="image/png" href="./img/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="./img/favicon.svg" />
    <link rel="shortcut icon" href="./img/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="TECH IN MY STYLE" />
    <link rel="manifest" href="./img/site.webmanifest" />

    <style>
        :root {
          --primary-light: #2196F3;
          --secondary-light: #64B5F6;
          --accent-light: #1976D2;
          --bg-light: #ffffff;
          --surface-light: rgba(255, 255, 255, 0.1);
          --text-light: #000000;
          --text-secondary-light: #333333;
          
          --primary-dark: #b388ff;
          --secondary-dark: #9c64ff;
          --accent-dark: #7c4dff;
          --bg-dark: #0a0a0a;
          --surface-dark: rgba(179, 136, 255, 0.1);
          --text-dark: #ffffff;
          --text-secondary-dark: #cccccc;
          
          --primary: var(--primary-light);
          --secondary: var(--secondary-light);
          --accent: var(--accent-light);
          --bg: var(--bg-light);
          --surface: var(--surface-light);
          --text: var(--text-light);
          --text-secondary: var(--text-secondary-light);
          
          --font-primary: 'Poppins', sans-serif;
          
          --spacing-xs: 0.5rem;
          --spacing-sm: 1rem;
          --spacing-md: 1.5rem;
          --spacing-lg: 2rem;
          --spacing-xl: 3rem;
          --spacing-2xl: 4rem;
          
          --radius-sm: 8px;
          --radius-md: 12px;
          --radius-lg: 16px;
          --radius-xl: 24px;
          
          --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
          --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
          --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
          --shadow-xl: 0 16px 64px rgba(0, 0, 0, 0.25);

          /* Leaderboard specific colors */
          --gold: #FFD700;
          --silver: #C0C0C0;
          --bronze: #CD7F32;
          --card: var(--bg-light);
          --header-bg: var(--primary-light);
          --header-text: #fff;
        }

        [data-theme="dark"] {
          --primary: var(--primary-dark);
          --secondary: var(--secondary-dark);
          --accent: var(--accent-dark);
          --bg: var(--bg-dark);
          --surface: var(--surface-dark);
          --text: var(--text-dark);
          --text-secondary: var(--text-secondary-dark);
          --card: #23263a;
          --header-bg: #23263a;
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: var(--font-primary);
          background: var(--bg);
          color: var(--text);
          line-height: 1.6;
          overflow-x: hidden;
          transition: all 0.3s ease;
          width: 100%;
          max-width: 100vw;
          cursor: none;
          min-height: 100vh;
        }

        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 var(--spacing-md);
          width: 100%;
        }

        #webgl-canvas {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: -1;
          pointer-events: none;
        }

        /* Custom cursor */
        .custom-cursor {
            position: fixed;
            width: 30px;
            height: 30px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            transition: width 0.2s, height 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
        }

        .cursor-dot {
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
        }

        a, button, .category-card, .course-card, .scroll-top, .nav-link, .switch, .user-link, tr, select, input, .closeModalBtn {
            cursor: none !important;
        }

        @media (max-width: 768px) {
            .custom-cursor {
                display: none !important;
            }
            
            body {
                cursor: auto !important;
            }
            
            a, button, .category-card, .course-card, .scroll-top, .nav-link, .switch, .user-link, tr, select, input, .closeModalBtn {
                cursor: pointer !important;
            }
        }

        /* HEADER */
        .header {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 1000;
          backdrop-filter: blur(20px);
          background: var(--surface);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          padding: var(--spacing-sm) 0;
          width: 100%;
          transition: all 0.3s ease;
        }

        .header .container {
          display: flex;
          justify-content: space-between;
          align-items: center;
          position: relative;
        }

        .logo h2 a {
          color: var(--primary);
          font-weight: 700;
          font-size: 1.2rem;
          text-decoration: none;
        }

        .mobile-menu-btn {
          display: none;
          background: none;
          border: none;
          color: var(--text);
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0.5rem;
          z-index: 1001;
        }

        .nav {
          display: flex;
          gap: var(--spacing-lg);
          align-items: center;
        }

        .nav-links {
          display: flex;
          gap: var(--spacing-md);
          align-items: center;
        }

        .nav-link {
          color: var(--text);
          text-decoration: none;
          font-weight: 500;
          transition: color 0.3s ease;
          position: relative;
          padding: 0.5rem 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.3rem;
        }

        .nav-link:hover,
        .nav-link.active {
          color: var(--primary);
        }

        .nav-link::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 0;
          height: 2px;
          background: var(--primary);
          transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
          width: 100%;
        }

        .nav-link i {
          font-size: 1.2rem;
        }

        .nav-link span {
          font-size: 0.8rem;
          font-weight: 500;
        }

        .theme-toggle {
          display: flex;
          align-items: center;
          gap: var(--spacing-xs);
          position: relative;
          z-index: 1002;
        }

        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 28px;
        }

        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: var(--surface);
          transition: 0.4s;
          border-radius: 28px;
          border: 2px solid var(--primary);
        }

        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 2px;
          bottom: 2px;
          background: var(--primary);
          transition: 0.4s;
          border-radius: 50%;
        }

        input:checked + .slider:before {
          transform: translateX(22px);
        }

        .mobile-header-controls {
          display: none;
          align-items: center;
          gap: var(--spacing-sm);
        }

        /* MOBILE NAVIGATION */
        @media (max-width: 768px) {
          .mobile-menu-btn {
            display: block;
          }

          .mobile-header-controls {
            display: flex;
          }

          .nav-links {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            background: var(--bg);
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            gap: 0;
            transition: all 0.3s ease;
            padding: 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 0;
            overflow: hidden;
            z-index: 999;
          }

          .nav-links.active {
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            padding: var(--spacing-md) 0;
          }

          .nav-link {
            font-size: 1.1rem;
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: left;
            width: 100%;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0;
            background: none;
            border-radius: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            flex-direction: row;
          }

          .nav-link:last-child {
            border-bottom: none;
          }

          .nav-link:hover {
            color: var(--primary);
            background: var(--surface);
            transform: none;
            padding-left: calc(var(--spacing-lg) + var(--spacing-sm));
          }

          .nav-link.active {
            color: var(--primary);
            background: var(--surface);
            font-weight: 600;
          }

          .nav-link::after {
            display: none;
          }

          .nav .theme-toggle {
            display: none;
          }

          .logo h2 a {
            font-size: 1rem;
          }

          .nav-link i {
            margin-right: var(--spacing-sm);
            width: 20px;
            text-align: center;
          }
        }

        /* MAIN CONTENT */
        .main-content {
          padding-top: 120px;
          min-height: 100vh;
          display: flex;
          justify-content: center;
          align-items: flex-start;
        }

        .leaderboard-container {
          max-width: 1200px;
          width: 100%;
          background: var(--card);
          border-radius: var(--radius-xl);
          box-shadow: var(--shadow-xl);
          overflow: hidden;
          margin: var(--spacing-xl) auto;
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-header {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          padding: var(--spacing-2xl) var(--spacing-xl);
          text-align: center;
          color: white;
        }

        .leaderboard-header h1 {
          font-size: clamp(2rem, 5vw, 3rem);
          margin: 0 0 var(--spacing-sm);
          font-weight: 700;
          letter-spacing: -1px;
        }

        .leaderboard-header p {
          font-size: 1.1rem;
          opacity: 0.9;
          margin: 0;
        }

        .controls {
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
          padding: var(--spacing-xl) var(--spacing-xl);
          background: var(--surface);
          backdrop-filter: blur(10px);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          flex-wrap: wrap;
        }

        input[type="text"], select {
          padding: var(--spacing-sm) var(--spacing-md);
          border-radius: var(--radius-md);
          border: 2px solid rgba(255, 255, 255, 0.1);
          font-size: 1rem;
          font-family: var(--font-primary);
          min-width: 200px;
          outline: none;
          transition: all 0.3s ease;
          background: var(--bg);
          color: var(--text);
          backdrop-filter: blur(10px);
        }

        input[type="text"]:focus, select:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
          transform: translateY(-2px);
        }

        select {
          min-width: 180px;
        }

        .spacer {
          flex: 1;
        }

        .theme-toggle-btn {
          background: linear-gradient(45deg, var(--primary), var(--secondary));
          color: white;
          border: none;
          padding: var(--spacing-sm) var(--spacing-lg);
          border-radius: var(--radius-md);
          cursor: pointer;
          font-size: 1rem;
          font-weight: 500;
          font-family: var(--font-primary);
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: var(--spacing-xs);
        }

        .theme-toggle-btn:hover {
          transform: translateY(-2px);
          box-shadow: var(--shadow-md);
        }

        .leaderboard-table-wrap {
          overflow-x: auto;
          margin: 0 var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
        }

        table {
          width: 100%;
          border-collapse: collapse;
          background: transparent;
          font-size: 1rem;
        }

        th {
          background: var(--surface);
          color: var(--primary);
          padding: var(--spacing-md) var(--spacing-sm);
          text-transform: uppercase;
          letter-spacing: 1px;
          font-size: 0.9rem;
          font-weight: 600;
          border-bottom: 2px solid var(--primary);
          user-select: none;
          position: sticky;
          top: 0;
          backdrop-filter: blur(10px);
        }

        td {
          text-align: center;
          padding: var(--spacing-md) var(--spacing-sm);
          font-weight: 500;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          background: transparent;
          transition: all 0.3s ease;
        }

        td.user-cell {
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
          justify-content: flex-start;
          text-align: left;
        }

        .rank-medal {
          font-size: 1.5rem;
          user-select: none;
        }

        .gold { color: var(--gold); }
        .silver { color: var(--silver); }
        .bronze { color: var(--bronze); }

        tr.top-row {
          font-weight: 700;
          background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05)) !important;
          border-left: 4px solid var(--gold);
        }

        tr:hover td {
          background: var(--surface);
          transform: scale(1.02);
          cursor: pointer;
        }

        .user-link {
          color: var(--primary);
          text-decoration: none;
          font-weight: 600;
          transition: all 0.3s ease;
          position: relative;
        }

        .user-link:hover {
          color: var(--secondary);
          transform: translateX(5px);
        }

        .user-link::after {
          content: '';
          position: absolute;
          bottom: -2px;
          left: 0;
          width: 0;
          height: 2px;
          background: var(--primary);
          transition: width 0.3s ease;
        }

        .user-link:hover::after {
          width: 100%;
        }

        .avatar {
          width: 45px;
          height: 45px;
          background: linear-gradient(45deg, var(--primary), var(--secondary));
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: white;
          font-size: 1.2rem;
          user-select: none;
          box-shadow: var(--shadow-sm);
          transition: all 0.3s ease;
        }

        .avatar:hover {
          transform: scale(1.1);
          box-shadow: var(--shadow-md);
        }

        /* Chart Styles */
        .chart-container {
          margin: var(--spacing-xl);
          padding: var(--spacing-xl);
          background: var(--surface);
          border-radius: var(--radius-lg);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        canvas {
          max-width: 100%;
          height: auto !important;
        }

        .back-btn {
          margin: var(--spacing-xl);
          display: inline-flex;
          align-items: center;
          gap: var(--spacing-sm);
          padding: var(--spacing-md) var(--spacing-xl);
          font-size: 1rem;
          border-radius: var(--radius-lg);
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: white;
          font-weight: 500;
          border: none;
          cursor: pointer;
          letter-spacing: 0.5px;
          transition: all 0.3s ease;
          user-select: none;
          font-family: var(--font-primary);
          text-decoration: none;
        }

        .back-btn:hover {
          transform: translateY(-3px);
          box-shadow: var(--shadow-lg);
        }

        /* Modal Styles */
        #progressModal {
          display: none;
          position: fixed;
          z-index: 10000;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.5);
          align-items: center;
          justify-content: center;
          padding: var(--spacing-md);
          overflow-y: auto;
          backdrop-filter: blur(5px);
        }

        #progressModal > div {
          background: var(--card);
          border-radius: var(--radius-xl);
          padding: var(--spacing-2xl);
          max-width: 1000px;
          width: 100%;
          max-height: 90vh;
          box-shadow: var(--shadow-xl);
          display: flex;
          gap: var(--spacing-2xl);
          color: var(--text);
          position: relative;
          flex-direction: column;
          align-items: stretch;
          overflow-y: auto;
        }

        #modalUser {
          font-weight: 600;
          font-size: 1.5rem;
          color: var(--primary);
          margin-bottom: var(--spacing-lg);
          text-align: center;
        }

        .closeModalBtn {
          position: absolute;
          top: var(--spacing-md);
          right: var(--spacing-lg);
          font-size: 2rem;
          background: none;
          border: none;
          cursor: pointer;
          color: var(--text);
          z-index: 10;
          user-select: none;
          transition: all 0.3s ease;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        }

        .closeModalBtn:hover {
          background: var(--surface);
          color: var(--primary);
          transform: scale(1.1);
        }

        .modal-content-bottom {
          display: flex;
          flex-wrap: wrap;
          gap: var(--spacing-xl);
          justify-content: center;
        }

        .modal-table-wrap, .modal-chart-wrap, .chart-card {
          flex: 1 1 320px;
          min-width: 300px;
          max-width: 420px;
          background: var(--surface);
          border-radius: var(--radius-lg);
          padding: var(--spacing-lg);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-summary {
          flex: 1 1 340px;
          min-width: 300px;
          max-width: 420px;
          display: flex;
          flex-direction: column;
          align-items: stretch;
        }

        #progressTable, #courseSummaryTable {
          width: 100%;
          border-collapse: separate;
          border-spacing: 0 var(--spacing-xs);
          font-size: 0.95rem;
          background: transparent;
          border-radius: var(--radius-md);
          overflow: hidden;
          margin-bottom: var(--spacing-md);
        }

        #progressTable th, #progressTable td, #courseSummaryTable th, #courseSummaryTable td {
          padding: var(--spacing-sm) var(--spacing-md);
          text-align: center;
          background: var(--bg);
          border: none;
          font-weight: 500;
          color: var(--text);
        }

        #progressTable th, #courseSummaryTable th {
          background: var(--primary);
          color: white;
          user-select: none;
          font-weight: 600;
        }

        #courseSummarySelect {
          font-size: 1rem;
          border-radius: var(--radius-md);
          border: 2px solid rgba(255, 255, 255, 0.1);
          appearance: none;
          cursor: pointer;
          margin-bottom: var(--spacing-md);
          padding: var(--spacing-sm) var(--spacing-md);
          width: 100%;
          user-select: none;
          background: var(--bg);
          color: var(--text);
          font-family: var(--font-primary);
          transition: all 0.3s ease;
        }

        #courseSummarySelect:focus {
          border-color: var(--primary);
          outline: none;
        }

        /* Fix for pie chart canvas sizing */
        #courseSummaryPie {
          width: 100% !important;
          height: 250px !important;
          max-height: 250px !important;
          display: block !important;
        }

        #userProgressChart {
          width: 100% !important;
          height: 300px !important;
          max-height: 300px !important;
          display: block !important;
        }

        /* FOOTER */
        .footer {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: white;
          padding: var(--spacing-2xl) 0 var(--spacing-lg);
        }

        .footer-content {
          display: grid;
          grid-template-columns: 1fr 2fr;
          gap: var(--spacing-2xl);
          margin-bottom: var(--spacing-xl);
        }

        .footer-brand h3 {
          font-size: 1.5rem;
          margin-bottom: var(--spacing-sm);
        }

        .footer-brand p {
          opacity: 0.9;
          font-size: 1rem;
        }

        .footer-links {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: var(--spacing-xl);
        }

        .footer-column h4 {
          margin-bottom: var(--spacing-md);
          font-weight: 600;
          font-size: 1.1rem;
          border-bottom: 2px solid rgba(255, 255, 255, 0.3);
          padding-bottom: var(--spacing-xs);
          display: inline-block;
        }

        .footer-column a {
          color: white;
          text-decoration: none;
          opacity: 0.8;
          transition: all 0.3s ease;
          display: block;
          margin-bottom: var(--spacing-xs);
          padding: var(--spacing-xs) 0;
          border-radius: var(--radius-sm);
          font-size: 0.9rem;
        }

        .footer-column a:hover {
          opacity: 1;
          background: rgba(255, 255, 255, 0.1);
          padding-left: var(--spacing-sm);
          transform: translateX(5px);
        }

        .footer-column a i {
          margin-right: var(--spacing-xs);
          width: 16px;
        }

        .footer-bottom {
          border-top: 1px solid rgba(255, 255, 255, 0.2);
          padding-top: var(--spacing-lg);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .scroll-top {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.2);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .scroll-top:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateY(-3px);
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1200px) {
          .leaderboard-container {
            margin: var(--spacing-md);
          }
        }

        @media (max-width: 768px) {
          .main-content {
            padding-top: 90px;
          }

          .controls {
            flex-direction: column;
            align-items: stretch;
            gap: var(--spacing-md);
          }

          .spacer {
            display: none;
          }

          input[type="text"], select {
            min-width: auto;
            width: 100%;
          }

          .leaderboard-table-wrap {
            margin: 0 var(--spacing-md) var(--spacing-md) var(--spacing-md);
          }

          th, td {
            padding: var(--spacing-sm);
            font-size: 0.9rem;
          }

          .avatar {
            width: 35px;
            height: 35px;
            font-size: 1rem;
          }

          .chart-container {
            margin: var(--spacing-md);
            padding: var(--spacing-lg);
          }

          .back-btn {
            margin: var(--spacing-md);
          }

          #progressModal > div {
            padding: var(--spacing-xl);
            gap: var(--spacing-lg);
          }

          .modal-content-bottom {
            flex-direction: column;
          }

          .modal-table-wrap, .modal-chart-wrap, .modal-summary {
            max-width: none;
            min-width: auto;
          }

          .footer-content {
            grid-template-columns: 1fr;
            text-align: center;
            gap: var(--spacing-xl);
          }

          .footer-links {
            grid-template-columns: 1fr;
            gap: var(--spacing-xl);
            text-align: left;
          }

          .footer-bottom {
            flex-direction: column;
            gap: var(--spacing-md);
            text-align: center;
          }
        }

        @media (max-width: 480px) {
          .leaderboard-header {
            padding: var(--spacing-xl) var(--spacing-md);
          }

          .controls {
            padding: var(--spacing-lg) var(--spacing-md);
          }

          .leaderboard-table-wrap {
            margin: 0 var(--spacing-sm) var(--spacing-sm) var(--spacing-sm);
          }

          th, td {
            padding: var(--spacing-xs);
            font-size: 0.8rem;
          }

          .user-cell {
            gap: var(--spacing-sm);
          }

          .avatar {
            width: 30px;
            height: 30px;
            font-size: 0.9rem;
          }

          .chart-container {
            margin: var(--spacing-sm);
            padding: var(--spacing-md);
          }

          .back-btn {
            margin: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
          }
        }

        /* Animations */
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(30px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .leaderboard-container {
          animation: fadeInUp 0.6s ease-out;
        }

        html {
          scroll-behavior: smooth;
        }

        /* Prevent horizontal scroll */
        body, html {
          max-width: 100vw;
          overflow-x: hidden;
        }

        * {
          max-width: 100%;
        }
    </style>
</head>
<body>
    <canvas id="webgl-canvas"></canvas>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <h2><a href='/'>TECH IN MY STYLE</a></h2>
            </div>
            
            <!-- Desktop Navigation -->
            <nav class="nav">
                <div class="nav-links" id="navLinks">
                    <a class='nav-link' href='/'><i class="fas fa-home"></i><span>Home</span></a>
                    <a class='nav-link' href='/courses'><i class="fas fa-book"></i><span>Courses</span></a>
                    <a class='nav-link' href='/about-us'><i class="fas fa-info-circle"></i><span>About Us</span></a>
                    <a class='nav-link' href='/stay-connected'><i class="fas fa-users"></i><span>Stay Connected</span></a>
                    <a class='nav-link' href='/feedback'><i class="fas fa-comment"></i><span>Feedback Center</span></a>
                    <a class='nav-link active' href='/leaderboard'><i class="fas fa-trophy"></i><span>Leaderboard</span></a>
                    <a class='nav-link' href='#' onclick="logout()"><i class="fas fa-arrow-right-from-bracket"></i><span>Logout</span></a>
                </div>
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="desktopThemeToggle">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
            </nav>
            
            <!-- Mobile Header Controls -->
            <div class="mobile-header-controls">
                <div class="theme-toggle">
                    <i class="fas fa-sun"></i>
                    <label class="switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                    </label>
                    <i class="fas fa-moon"></i>
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="leaderboard-container" role="main">
            <section class="leaderboard-header">
                <h1>🏆 Leaderboard</h1>
                <p>Click a username for full course progress details and track your learning journey.</p>
            </section>
            
            <section class="controls" aria-label="Search and filter leaderboard">
                <input type="text" id="searchInput" aria-label="Search user" placeholder="🔍 Search user..." />
                <select id="sortSelect" aria-label="Sort leaderboard">
                    <option value="rank">Sort by Rank</option>
                    <option value="score">Sort by Score</option>
                    <option value="user">Sort by Username</option>
                </select>
                <span class="spacer" aria-hidden="true"></span>
                <button class="theme-toggle-btn" aria-pressed="false" aria-label="Toggle dark/light theme" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                    Toggle Theme
                </button>
            </section>
            
            <section class="leaderboard-table-wrap" aria-label="Leaderboard table">
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Rank</th>
                            <th scope="col">User</th>
                            <th scope="col">Total Tasks</th>
                        </tr>
                    </thead>
                    <tbody id="board" role="rowgroup"></tbody>
                </table>
            </section>
            
            <div class="chart-container">
                <canvas id="scoreChart" height="90" role="img" aria-label="Bar chart of total tasks completed by users"></canvas>
            </div>
            
            <a href="../index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>
    </main>

    <!-- Modal for user progress -->
    <div id="progressModal" role="dialog" aria-modal="true" aria-labelledby="modalUser" tabindex="-1">
        <div>
            <button class="closeModalBtn" onclick="closeModal()" aria-label="Close modal">&times;</button>
            <div id="modalUser" aria-live="polite">User Progress</div>
            <div class="modal-content-bottom">
                <div class="modal-table-wrap chart-card">
                    <table id="progressTable" aria-label="Course-wise progress table" hidden>
                        <thead><tr><th>Course Name</th><th>Tasks Completed</th></tr></thead>
                        <tbody id="progressTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-chart-wrap chart-card">
                    <canvas id="userProgressChart" width="360" height="300"></canvas>
                </div>
                <div class="modal-summary chart-card">
                    <select id="courseSummarySelect" aria-label="Select course for summary"></select>
                    <table id="courseSummaryTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Completed</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="summaryCourse">&ndash;</td>
                                <td id="summaryCompleted">0</td>
                                <td id="summaryTotal">0</td>
                            </tr>
                        </tbody>
                    </table>
                    <canvas id="courseSummaryPie" width="280" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>TECH IN MY STYLE</h3>
                    <p>Empowering the next generation of developers with hands-on learning experiences and industry-recognized certifications.</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h4>Quick Links</h4>
                        <a href="/">HOME</a>
                        <a href="/courses">COURSES</a>
                        <a href="/about-us">ABOUT US</a>
                        <a href="/stay-connected">STAY CONNECTED</a>
                        <a href="/feedback">Feedback Center</a>
                    </div>
                    <div class="footer-column">
                        <h4>Courses</h4>
                        <a href="/HTML IN MY STYLE/index.html">HTML IN MY STYLE</a>
                        <a href="/CSS IN MY STYLE/index.html">CSS IN MY STYLE</a>
                        <a href="/JAVASCRIPT IN MY STYLE - BASIC/index.html">JS IN MY STYLE (BASIC)</a>
                        <a href="/JAVASCRIPT IN MY STYLE - INTERMEDIATE/index.html">JS IN MY STYLE (INTERMEDIATE)</a>
                        <a href="/C IN MY STYLE/index.html">C IN MY STYLE</a>
                        <a href="/JAVA IN MY STYLE/index.html">JAVA IN MY STYLE</a>
                        <a href="/PYTHON IN MY STYLE/index.html">PYTHON IN MY STYLE</a>
                        <a href="/ML IN MY STYLE/index.html">ML IN MY STYLE</a>
                        <a href="/DL IN MY STYLE/index.html">DL IN MY STYLE</a>
                        <a href="/DSC IN MY STYLE/index.html">DSC IN MY STYLE</a>
                        <a href="/AI IN MY STYLE/index.html">AI IN MY STYLE</a>
                    </div>
                    <div class="footer-column">
                        <h4>Support</h4>
                        <a href="https://www.instagram.com/techinmystyle"><i class="fab fa-instagram"></i> Instagram</a>
                        <a href="https://www.youtube.com/@TECHINMYSTYLE"><i class="fab fa-youtube"></i> YouTube</a>
                        <a href="https://whatsapp.com/channel/0029VbAZrCD5fM5aOU10Av0d"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                        <a href="https://t.me/Tech_in_my_style_bot"><i class="fab fa-telegram"></i> Telegram</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 TECH IN MY STYLE. All rights reserved.</p>
                <div class="scroll-top" onclick="scrollToTop()">
                    <i class="fas fa-arrow-up"></i>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 600,
            easing: 'ease-in-out',
            once: false,
            mirror: true,
            offset: 20
        });

        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navLinks = document.getElementById('navLinks');
        const menuIcon = mobileMenuBtn.querySelector('i');
        const header = document.querySelector('.header');

        mobileMenuBtn.addEventListener('click', function() {
            navLinks.classList.toggle('active');
            
            if (navLinks.classList.contains('active')) {
                menuIcon.className = 'fas fa-times';
                header.style.borderBottom = 'none';
            } else {
                menuIcon.className = 'fas fa-bars';
                header.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
            }
        });

        // Close mobile menu when clicking on nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                navLinks.classList.remove('active');
                menuIcon.className = 'fas fa-bars';
                header.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
            });
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!navLinks.contains(event.target) && 
                !mobileMenuBtn.contains(event.target) && 
                !event.target.closest('.mobile-header-controls') &&
                navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
                menuIcon.className = 'fas fa-bars';
                header.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
            }
        });

        // Sync Theme Toggles
        const mobileThemeToggle = document.getElementById('themeToggle');
        const desktopThemeToggle = document.getElementById('desktopThemeToggle');
        const body = document.body;

        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            body.setAttribute('data-theme', 'dark');
            mobileThemeToggle.checked = true;
            desktopThemeToggle.checked = true;
        }

        function syncThemeToggles(isDark) {
            mobileThemeToggle.checked = isDark;
            desktopThemeToggle.checked = isDark;
            
            if (isDark) {
                body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
        }

        mobileThemeToggle.addEventListener('change', function() {
            syncThemeToggles(this.checked);
        });

        desktopThemeToggle.addEventListener('change', function() {
            syncThemeToggles(this.checked);
        });

        // WebGL Animation with Three.js
        function initWebGL() {
            const canvas = document.getElementById('webgl-canvas');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                alpha: true,
                antialias: true
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCount = 1500;
            
            const posArray = new Float32Array(particlesCount * 3);
            
            for (let i = 0; i < particlesCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 5;
            }
            
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            
            const getParticleColor = () => {
                const isDarkTheme = document.body.getAttribute('data-theme') === 'dark';
                return isDarkTheme ? 0xb388ff : 0x2196F3;
            };
            
            let particlesMaterial = new THREE.PointsMaterial({
                size: 0.02,
                color: getParticleColor(),
                transparent: true,
                opacity: 0.8
            });
            
            const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particlesMesh);
            
            camera.position.z = 2;
            
            let mouseX = 0;
            let mouseY = 0;
            let targetRotationX = 0;
            let targetRotationY = 0;
            let currentRotationX = 0;
            let currentRotationY = 0;
            let isMoving = false;
            let moveTimeout;
            
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth - 0.5) * 0.05;
                mouseY = (event.clientY / window.innerHeight - 0.5) * 0.05;
                
                targetRotationX = mouseY;
                targetRotationY = mouseX;
                
                isMoving = true;
                
                clearTimeout(moveTimeout);
                
                moveTimeout = setTimeout(() => {
                    isMoving = false;
                }, 1000);
            });
            
            function updateParticleColor() {
                setTimeout(() => {
                    particlesMaterial.color.setHex(getParticleColor());
                }, 100);
            }
            
            mobileThemeToggle.addEventListener('change', updateParticleColor);
            desktopThemeToggle.addEventListener('change', updateParticleColor);
            
            const animate = () => {
                requestAnimationFrame(animate);
                
                particlesMesh.rotation.x += 0.0002;
                particlesMesh.rotation.y += 0.0002;
                
                if (isMoving) {
                    currentRotationX += (targetRotationX - currentRotationX) * 0.1;
                    currentRotationY += (targetRotationY - currentRotationY) * 0.1;
                    
                    particlesMesh.rotation.x += currentRotationX;
                    particlesMesh.rotation.y += currentRotationY;
                } else {
                    currentRotationX *= 0.95;
                    currentRotationY *= 0.95;
                    
                    particlesMesh.rotation.x += currentRotationX;
                    particlesMesh.rotation.y += currentRotationY;
                }
                
                renderer.render(scene, camera);
            };
            
            animate();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        if (window.WebGLRenderingContext) {
            try {
                initWebGL();
            } catch (e) {
                console.log('WebGL initialization failed:', e);
            }
        }

        // Custom cursor implementation - improved
        function initCustomCursor() {
            if (window.innerWidth <= 768) return; // Don't initialize on mobile
            
            const cursor = document.createElement('div');
            cursor.classList.add('custom-cursor');
            
            const cursorDot = document.createElement('div');
            cursorDot.classList.add('cursor-dot');
            
            cursor.appendChild(cursorDot);
            document.body.appendChild(cursor);
            
            let mouseX = 0;
            let mouseY = 0;
            let isVisible = true;
            
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                if (!isVisible) {
                    cursor.style.opacity = '1';
                    cursor.style.visibility = 'visible';
                    isVisible = true;
                }
                
                cursor.style.left = mouseX + 'px';
                cursor.style.top = mouseY + 'px';
            });
            
            // Handle hover effects
            const clickableElements = document.querySelectorAll('a, button, tr, .user-link, .scroll-top, .nav-link, .switch, select, input, .closeModalBtn');
            
            function addHoverListeners() {
                clickableElements.forEach(element => {
                    element.addEventListener('mouseenter', () => {
                        cursor.style.width = '40px';
                        cursor.style.height = '40px';
                    });
                    
                    element.addEventListener('mouseleave', () => {
                        cursor.style.width = '30px';
                        cursor.style.height = '30px';
                    });
                });
            }
            
            addHoverListeners();
            
            // Handle mouse leaving window
            document.addEventListener('mouseleave', () => {
                cursor.style.opacity = '0';
                cursor.style.visibility = 'hidden';
                isVisible = false;
            });
            
            document.addEventListener('mouseenter', () => {
                cursor.style.opacity = '1';
                cursor.style.visibility = 'visible';
                isVisible = true;
            });
            
            // Re-add listeners for dynamically created elements
            const observer = new MutationObserver(() => {
                addHoverListeners();
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        initCustomCursor();

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Header Background on Scroll
        window.addEventListener('scroll', () => {
            const header = document.querySelector('.header');
            if (window.scrollY > 100) {
                header.style.background = 'rgba(255, 255, 255, 0.95)';
                if (document.body.getAttribute('data-theme') === 'dark') {
                    header.style.background = 'rgba(10, 10, 10, 0.95)';
                }
            } else {
                header.style.background = 'var(--surface)';
            }
        });

        function logout() {
            localStorage.clear();
            window.location.href = "auth/login.html";
        }

        // Handle window resize for mobile optimization
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                navLinks.classList.remove('active');
                menuIcon.className = 'fas fa-bars';
                header.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
                
                // Reinitialize cursor for desktop
                if (!document.querySelector('.custom-cursor')) {
                    initCustomCursor();
                }
            } else {
                // Remove cursor on mobile
                const existingCursor = document.querySelector('.custom-cursor');
                if (existingCursor) {
                    existingCursor.remove();
                }
            }
        });

        // LEADERBOARD FUNCTIONALITY
        Chart.register({
          id: 'customBgCard',
          beforeDraw: (chart) => {
            const ctx = chart.canvas.getContext('2d');
            ctx.save();
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card') || '#fff';
            ctx.fillRect(0, 0, chart.width, chart.height);
            ctx.restore();
          }
        });

        let leaderboardData = [];
        let courseTotals = {};
        let currentUserProgress = null;
        let progressChartInstance = null;
        let courseSummaryPieInstance = null;
        const medals = [
          '<span class="rank-medal gold">🥇</span>',
          '<span class="rank-medal silver">🥈</span>',
          '<span class="rank-medal bronze">🥉</span>'
        ];
        const chartCtx = document.getElementById('scoreChart').getContext('2d');
        let scoreChart;
        Chart.register(ChartDataLabels);

        // Helper: get user's initials
        function getInitials(name) {
          if (!name) return "U";
          const parts = name.split(/[ ._]/).filter(Boolean);
          return parts.length === 1 ? parts[0][0].toUpperCase() : (parts[0][0] + parts[1][0]).toUpperCase();
        }

        function renderTable(data) {
          const tbody = document.getElementById("board");
          tbody.innerHTML = "";
          data.forEach((userData, i) => {
            tbody.innerHTML += `
            <tr class="${i < 3 ? 'top-row' : ''}">
              <td>${i < 3 ? medals[i] : (i + 1)}</td>
              <td class="user-cell">
                <span class="avatar">${getInitials(userData.user)}</span>
                <a href="#" class="user-link" data-username="${userData.user}" tabindex="0">${userData.user}</a>
              </td>
              <td>${userData.score}</td>
            </tr>
            `;
          });
        }

        function updateChart(data) {
          const labels = data.map(u => u.user);
          const scores = data.map(u => u.score);
          if(scoreChart) { scoreChart.destroy(); scoreChart = null; }
          scoreChart = new Chart(chartCtx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Total Tasks Completed',
                data: scores,
                backgroundColor: getComputedStyle(document.body).getPropertyValue('--primary') || '#2196F3',
                borderColor: getComputedStyle(document.body).getPropertyValue('--primary') || '#2196F3',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {display: false},
                datalabels: {
                  color: 'white',
                  anchor: 'end',
                  align: 'top',
                  formatter: v => v,
                  font: {
                    weight: 'bold',
                    size: 12
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { 
                    stepSize: 1,
                    color: getComputedStyle(document.body).getPropertyValue('--text') || '#000'
                  },
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  }
                },
                x: {
                  ticks: {
                    color: getComputedStyle(document.body).getPropertyValue('--text') || '#000'
                  },
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  }
                }
              }
            },
            plugins: [ChartDataLabels]
          });
        }

        function applySearchAndSort() {
          const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
          const sortValue = document.getElementById('sortSelect').value;
          let filtered = leaderboardData.filter(u => u.user.toLowerCase().includes(searchTerm));
          if(sortValue === "user") {
            filtered.sort((a,b) => a.user.localeCompare(b.user));
          } else if(sortValue === "score") {
            filtered.sort((a,b) => b.score - a.score);
          } else { //rank
            filtered.sort((a,b) => b.score - a.score);
          }
          renderTable(filtered);
          updateChart(filtered);
        }

        async function loadCourseTotals() {
          try {
            const res = await fetch('https://tech-trail-w2ap.onrender.com/courses/meta');
            if(!res.ok) throw new Error("Failed to fetch course totals");
            courseTotals = await res.json();
          } catch {
            courseTotals = {
              "ai": 30,"ml":30,"dl":30,"java":30,"c":30,"html":30,
              "css":30,"js":30,"js-intermediate":30,"python":30,"dsc":30
            };
          }
        }

        async function loadBoard() {
          await loadCourseTotals();
          try {
            const res = await fetch('https://tech-trail-w2ap.onrender.com/leaderboard');
            if (!res.ok) throw new Error("Failed to fetch leaderboard");
            leaderboardData = await res.json();
            applySearchAndSort();
          } catch(e) {
            document.getElementById("board").innerHTML = `<tr><td colspan="3">⚠ Failed to load leaderboard.</td></tr>`;
            console.error(e);
          }
        }

        function toggleTheme() {
          const isDark = document.body.getAttribute('data-theme') === 'dark';
          syncThemeToggles(!isDark);
        }

        function goHome() {
          window.location.href = "../index.html";
        }

        function closeModal() {
          if(progressChartInstance) { 
            progressChartInstance.destroy(); 
            progressChartInstance = null;
          }
          if(courseSummaryPieInstance) { 
            courseSummaryPieInstance.destroy(); 
            courseSummaryPieInstance = null;
          }
          const modal = document.getElementById('progressModal');
          if(modal) modal.style.display = 'none';
        }

        function renderProgressChart() {
          if (!currentUserProgress) return;
          
          const ctx = document.getElementById('userProgressChart').getContext('2d');
          if(progressChartInstance) { 
            progressChartInstance.destroy(); 
            progressChartInstance = null;
          }
          
          const labels = Object.keys(currentUserProgress);
          const data = labels.map(c => currentUserProgress[c]?.length || 0);
          const bgColors = [
            '#3574e6','#56b881','#ef476f','#ffd166',
            '#06d6a0','#118ab2','#b388eb','#f78fb3'
          ];
          
          if (labels.length === 0) {
            // Show a placeholder chart if no data
            progressChartInstance = new Chart(ctx, {
              type: 'pie',
              data: {
                labels: ['No Progress'],
                datasets: [{
                  data: [1],
                  backgroundColor: ['#cccccc'],
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {display: true, position: 'bottom'},
                  datalabels: {
                    display: false
                  }
                }
              },
              plugins: [ChartDataLabels]
            });
            return;
          }
          
          progressChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: bgColors.slice(0, labels.length),
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {display: true, position: 'bottom'},
                datalabels: {
                  color: '#fff',
                  font: {weight: 'bold', size: 14},
                  formatter: (value, context) => {
                    const {dataset} = context;
                    const total = dataset.data.reduce((a,b) => a+b, 0) || 1;
                    return ((value/total)*100).toFixed(1) + '%';
                  }
                }
              }
            },
            plugins: [ChartDataLabels]
          });
        }

        function updateCourseSummaryDropdown() {
          const select = document.getElementById('courseSummarySelect');
          select.innerHTML = '';
          
          // Add a default option
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Select a course';
          select.appendChild(defaultOption);
          
          Object.keys(courseTotals).forEach(course => {
            const opt = document.createElement('option');
            opt.value = course;
            opt.textContent = course.toUpperCase();
            select.appendChild(opt);
          });
        }

        function updateCourseSummary(course) {
          const canvas = document.getElementById('courseSummaryPie');
          const table = document.getElementById('courseSummaryTable');
          
          // Clean up previous chart
          if(courseSummaryPieInstance) { 
            courseSummaryPieInstance.destroy(); 
            courseSummaryPieInstance = null;
          }
          
          if(!course || !currentUserProgress || !courseTotals[course]) {
            table.style.display = 'none';
            // Clear the canvas
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            return;
          }
          
          // Show and update table
          table.style.display = '';
          const total = courseTotals[course] ?? 0;
          const completed = (currentUserProgress && currentUserProgress[course]) ? currentUserProgress[course].length : 0;
          
          document.getElementById('summaryCourse').textContent = course.toUpperCase();
          document.getElementById('summaryTotal').textContent = total;
          document.getElementById('summaryCompleted').textContent = completed;
          
          // Create the pie chart
          const ctx = canvas.getContext('2d');
          const remaining = Math.max(total - completed, 0);
          
          courseSummaryPieInstance = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: ['Completed', 'Remaining'],
              datasets: [{
                data: [completed, remaining],
                backgroundColor: ['#56b881', 'rgba(255,255,255,0.3)'],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true, 
                  position: 'bottom',
                  labels: {
                    color: getComputedStyle(document.body).getPropertyValue('--text') || '#000',
                    font: {
                      size: 12
                    }
                  }
                },
                datalabels: {
                  color: '#fff',
                  font: {weight: 'bold', size: 12},
                  formatter: (value, context) => {
                    if (value === 0) return '';
                    return value;
                  }
                }
              },
              layout: {
                padding: 10
              }
            },
            plugins: [ChartDataLabels]
          });
          
          // Force a redraw
          setTimeout(() => {
            if (courseSummaryPieInstance) {
              courseSummaryPieInstance.update();
            }
          }, 100);
        }

        async function loadUserProgress(username) {
          const modal = document.getElementById('progressModal');
          if (!modal) return alert("Modal element not found.");
          
          const modalUser = document.getElementById('modalUser');
          modalUser.textContent = `Course Progress for ${username}`;
          modal.style.display = 'flex';
          
          // Reset progress data
          currentUserProgress = null;
          
          const progressTable = document.getElementById('progressTable');
          const progressTableBody = document.getElementById('progressTableBody');
          progressTable.hidden = true;
          progressTableBody.innerHTML = '';
          
          // Clean up previous charts
          if(progressChartInstance) { 
            progressChartInstance.destroy(); 
            progressChartInstance = null;
          }
          if(courseSummaryPieInstance) { 
            courseSummaryPieInstance.destroy(); 
            courseSummaryPieInstance = null;
          }
          
          // Reset dropdowns and tables
          document.getElementById('courseSummarySelect').innerHTML = '';
          document.getElementById('courseSummaryTable').style.display = 'none';
          
          try {
            const res = await fetch(`https://tech-trail-w2ap.onrender.com/progress/${encodeURIComponent(username)}`);
            if (!res.ok) throw new Error("Failed to fetch user progress");
            
            const prog = await res.json();
            currentUserProgress = prog;
            
            const courses = Object.keys(prog);
            if (courses.length === 0) {
              progressTableBody.innerHTML = `<tr><td colspan="2">No task progress found for this user.</td></tr>`;
            } else {
              progressTableBody.innerHTML = courses.map(course => {
                const taskCount = prog[course].length;
                return `<tr><td>${course.toUpperCase()}</td><td>${taskCount}</td></tr>`;
              }).join('');
            }
            
            progressTable.hidden = false;
            
            // Render charts with delay to ensure proper initialization
            setTimeout(() => {
              renderProgressChart();
              updateCourseSummaryDropdown();
              
              const dropdown = document.getElementById('courseSummarySelect');
              dropdown.onchange = (e) => updateCourseSummary(e.target.value);
              
              // Auto-select first course if available
              if (courses.length > 0) {
                dropdown.value = courses[0];
                updateCourseSummary(courses[0]);
              }
            }, 200);
            
          } catch(e) {
            progressTableBody.innerHTML = `<tr><td colspan="2" style="color:#ea5252;">Failed to load progress data.</td></tr>`;
            progressTable.hidden = false;
            console.error(e);
          }
        }

        // Event listeners
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('user-link')) {
            e.preventDefault();
            loadUserProgress(e.target.getAttribute('data-username'));
          }
        });

        document.getElementById("searchInput").addEventListener("input", applySearchAndSort);
        document.getElementById("sortSelect").addEventListener("change", applySearchAndSort);
        
        document.addEventListener("keydown", function(e) {
          if (document.getElementById('progressModal').style.display === 'flex') {
            if (e.key === "Escape") { 
              closeModal(); 
            }
          }
        });

        // Load leaderboard data
        loadBoard();

        // Disable right click and dev tools
        document.addEventListener("contextmenu", (e) => e.preventDefault());

        document.onkeydown = function(e) {
          if (e.keyCode === 123) return false;
          if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) {
            return false;
          }
          if (e.ctrlKey && e.keyCode === 85) return false;
          if (e.ctrlKey && e.keyCode === 83) return false;
          if (e.ctrlKey && (e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86 || e.keyCode === 80)) {
            return false;
          }
          if (e.ctrlKey && e.shiftKey && e.keyCode === 75) return false;
        };
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7G01YFBCVB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-7G01YFBCVB');
    </script>
</body>
</html>
